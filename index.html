<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Captura de Foto</title>
</head>
<body>
    <h1>Captura de Foto</h1>
    <input type="file" accept="image/*" capture="camera" id="cameraInput">
    <button id="uploadButton">Enviar para Google Drive</button>
    
    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        let isGAPIInitialized = false;

        function initGAPI() {
            gapi.load('client:auth2', function() {
                gapi.auth2.init({
                    client_id: '294110654965-5kf1vog63kktsmhd607i87f3i7tbv113.apps.googleusercontent.com',
                    scope: 'https://www.googleapis.com/auth/drive.file',
                    cookie_policy: 'single_host_origin'
                }).then(function() {
                    console.log('API do Google autenticada e pronta para uso');
                    isGAPIInitialized = true; // Marcar como inicializado
                }).catch(function(error) {
                    console.error('Erro ao inicializar a API:', error);
                });
            });
        }

        document.getElementById('uploadButton').onclick = function() {
            if (!isGAPIInitialized) {
                alert("A API do Google não foi inicializada. Tente novamente mais tarde.");
                return;
            }

            const fileInput = document.getElementById('cameraInput');
            const file = fileInput.files[0];
            if (!file) {
                alert("Por favor, tire uma foto primeiro.");
                return;
            }
            uploadToDrive(file);
        };

        function uploadToDrive(file) {
            const authInstance = gapi.auth2.getAuthInstance();
            if (!authInstance) {
                console.error('Erro: authInstance não está disponível.');
                return;
            }

            authInstance.signIn().then(function() {
                const token = gapi.auth.getToken();
                if (!token) {
                    console.error('Erro ao obter o token de acesso.');
                    return;
                }
                uploadFile(file, token.access_token);
            }).catch(function(error) {
                console.error('Erro na autenticação:', error);
            });
        }

        function uploadFile(file, accessToken) {
            const metadata = {
                'name': file.name,
                'mimeType': file.type
            };
            const form = new FormData();
            form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
            form.append('file', file);

            const xhr = new XMLHttpRequest();
            xhr.open('POST', 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart');
            xhr.setRequestHeader('Authorization', 'Bearer ' + accessToken);
            xhr.responseType = 'json';
            xhr.onload = function() {
                console.log(xhr.response);
                alert('Arquivo enviado com sucesso!');
            };
            xhr.onerror = function() {
                console.error('Erro na requisição:', xhr.responseText);
            };
            xhr.send(form);
        }

        // Chamar a função de inicialização assim que a API for carregada
        window.onload = initGAPI;
    </script>
</body>
</html>
